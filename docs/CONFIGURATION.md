# Configuration Guide

Comprehensive guide to configuring the Casino Intelligence Platform.

## Environment Variables

### Required Variables

#### Convex Configuration

```env
# Auto-generated by `npx convex dev`
CONVEX_DEPLOYMENT=your-deployment-name
NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
```

#### OpenAI Configuration

```env
# Get from https://platform.openai.com
OPENAI_API_KEY=sk-your-openai-api-key
```

### Optional Variables

#### Upstash Redis (Caching)

```env
# Get from https://upstash.com
UPSTASH_REDIS_REST_URL=https://your-redis.upstash.io
UPSTASH_REDIS_REST_TOKEN=your-redis-token
```

#### Vercel Analytics

```env
# Automatically set by Vercel
NEXT_PUBLIC_VERCEL_URL=your-app.vercel.app
```

## Convex Configuration

### Cron Jobs

Located in `convex/crons.ts`:

```typescript
import { cronJobs } from 'convex/server';
import { internal } from './_generated/api';

const crons = cronJobs();

// Offer research - runs daily at 2 AM UTC
crons.daily(
  'daily-offer-research',
  { hourUTC: 2, minuteUTC: 0 },
  internal.offers.actions.processOfferResearchBatchAction
);

// Casino discovery - runs every 12 hours
crons.interval('casino-discovery', { hours: 12 }, internal.casinos.actions.scheduledCasinoDiscovery);

export default crons;
```

**Customization Options:**

Change frequency:

```typescript
// Every 6 hours
crons.interval('job-name', { hours: 6 }, handler);

// Every day at specific time
crons.daily('job-name', { hourUTC: 8, minuteUTC: 30 }, handler);

// Weekly on Monday at 9 AM
crons.weekly(
  'job-name',
  {
    weekday: 'monday',
    hourUTC: 9,
    minuteUTC: 0,
  },
  handler
);

// Monthly on the 1st at midnight
crons.monthly(
  'job-name',
  {
    day: 1,
    hourUTC: 0,
    minuteUTC: 0,
  },
  handler
);
```

Disable a cron job:

```typescript
// Comment out or remove the cron definition
// crons.daily("job-name", {...}, handler);
```

### Database Indexes

Defined in table models (e.g., `convex/casinos/casinos.model.ts`):

```typescript
export const casinos = defineTable({
  name: v.string(),
  state_id: v.id('states'),
  is_tracked: v.boolean(),
  last_offer_check: v.optional(v.number()),
})
  .index('by_state', ['state_id'])
  .index('by_tracking', ['is_tracked'])
  .index('by_last_check', ['last_offer_check']);
```

**Adding New Indexes:**

1. Add index to table definition
2. Run `npx convex dev` to apply changes
3. Indexes are automatically created

**Best Practices:**

- Index fields used in `where` clauses
- Index fields used for sorting
- Avoid over-indexing (impacts write performance)

## Application Configuration

### Batch Processing

**Offer Research Batch Size**

Location: `convex/casinos/queries/getCasinosForOfferResearch.ts`

```typescript
export const getCasinosForOfferResearchHandler = async (ctx: QueryCtx, args: { batchSize?: number }) => {
  const batchSize = args.batchSize || 30; // Default: 30
  // ...
};
```

Change default batch size:

```typescript
const batchSize = args.batchSize || 50; // Process 50 casinos
```

**Priority Split**

Location: `convex/casinos/queries/getCasinosForOfferResearch.ts`

```typescript
const TRACKED_PERCENTAGE = 0.7; // 70% tracked, 30% untracked
const trackedCount = Math.floor(batchSize * TRACKED_PERCENTAGE);
const untrackedCount = batchSize - trackedCount;
```

Adjust priority:

```typescript
const TRACKED_PERCENTAGE = 0.8; // 80% tracked, 20% untracked
```

### Duplicate Detection

**Similarity Threshold**

Location: `src/features/casino-discovery/services/casino-duplicate-detector.service.ts`

```typescript
const SIMILARITY_THRESHOLD = 0.8; // 80% similarity
```

Adjust threshold:

```typescript
const SIMILARITY_THRESHOLD = 0.85; // More strict (85%)
const SIMILARITY_THRESHOLD = 0.75; // More lenient (75%)
```

**Detection Methods**

Enable/disable specific detection methods:

```typescript
export class CasinoDuplicateDetector {
  static findDuplicateCasino(
    newCasino: Partial<Doc<'casinos'>>,
    existingCasinos: any[]
  ) {
    // Exact match (always enabled)
    if (normalizedNew === normalizedExisting) {
      return { duplicate, reason: 'Exact name match' };
    }

    // Substring match (toggle here)
    const enableSubstringMatch = true;
    if (enableSubstringMatch && /* ... */) {
      return { duplicate, reason: 'Substring match' };
    }

    // Similarity scoring (toggle here)
    const enableSimilarityScore = true;
    if (enableSimilarityScore && /* ... */) {
      return { duplicate, reason: 'High similarity', score };
    }
  }
}
```

### Pagination

**Default Page Size**

Location: `convex/casinos/queries/getCasinosPaginated.ts`

```typescript
export const getCasinosPaginatedHandler = async (
  ctx: QueryCtx,
  args: {
    page?: number;
    pageSize?: number;
    // ...
  }
) => {
  const page = args.page || 1;
  const pageSize = args.pageSize || 20; // Default: 20 per page
  // ...
};
```

Change default:

```typescript
const pageSize = args.pageSize || 50; // 50 per page
```

## AI Configuration

### OpenAI Model Settings

**Model Selection**

Location: `src/features/casino-discovery/ai-agent/discover-casino.ts`

```typescript
const completion = await openai.chat.completions.create({
  model: 'gpt-4o-mini', // Cost-optimized model
  // ...
});
```

Switch models:

```typescript
model: 'gpt-4o',        // More capable, higher cost
model: 'gpt-4o-mini',   // Balanced (recommended)
model: 'gpt-3.5-turbo', // Faster, cheaper, less capable
```

**Temperature**

Control randomness/creativity:

```typescript
const completion = await openai.chat.completions.create({
  model: 'gpt-4o-mini',
  temperature: 0.7, // 0.0 = deterministic, 1.0 = creative
  // ...
});
```

**Max Tokens**

Limit response length:

```typescript
const completion = await openai.chat.completions.create({
  model: 'gpt-4o-mini',
  max_tokens: 4000, // Maximum tokens in response
  // ...
});
```

### Web Search Configuration

**Search Tool Enabled**

Location: AI agent files

```typescript
const tools = [
  {
    type: 'web_search',
    web_search: {
      query: 'licensed casinos in New Jersey',
    },
  },
];
```

Disable web search (use only training data):

```typescript
// Remove tools array or set to empty
const tools = [];
```

## UI Configuration

### Theme Configuration

Location: `tailwind.config.ts`

```typescript
export default {
  darkMode: ['class'],
  theme: {
    extend: {
      colors: {
        // Customize colors
        primary: {
          DEFAULT: '#...',
          foreground: '#...',
        },
      },
    },
  },
};
```

### Dashboard Refresh Intervals

For real-time updates, Convex automatically handles subscriptions. To manually control:

```typescript
// In a component
const { data } = useQuery(api.casinos.index.getCasinoStats);

// Add polling interval if needed
useEffect(() => {
  const interval = setInterval(() => {
    // Manually refetch
  }, 5000); // Every 5 seconds

  return () => clearInterval(interval);
}, []);
```

### Chart Configuration

Location: Dashboard component files (e.g., `src/features/casino-dashboard/components/state-chart.tsx`)

```typescript
<ResponsiveContainer width="100%" height={400}>
  <BarChart data={data}>
    {/* Customize chart appearance */}
  </BarChart>
</ResponsiveContainer>
```

Change colors, height, tooltips, etc.

## Performance Configuration

### Next.js Configuration

Location: `next.config.ts`

```typescript
const nextConfig = {
  // Enable Turbopack
  experimental: {
    turbo: true,
  },

  // Image optimization
  images: {
    domains: ['your-cdn-domain.com'],
  },

  // Redirects
  async redirects() {
    return [
      {
        source: '/',
        destination: '/dashboard/casino',
        permanent: false,
      },
    ];
  },
};
```

### Redis Cache TTL

Location: `src/lib/redis.ts`

```typescript
// Set cache expiration
await redis.set('key', 'value', { ex: 3600 }); // 1 hour

// Adjust TTL per use case
await redis.set('casino-stats', stats, { ex: 300 }); // 5 minutes
await redis.set('offer-data', offers, { ex: 86400 }); // 24 hours
```

## Development vs Production

### Environment-Specific Settings

```typescript
// Check environment
const isProd = process.env.NODE_ENV === 'production';

// Different behavior based on environment
const batchSize = isProd ? 30 : 5; // Smaller batches in dev
const cacheTimeout = isProd ? 3600 : 60; // Shorter cache in dev
```

### Feature Flags

Create a config file:

```typescript
// src/lib/config.ts
export const config = {
  features: {
    enableAutoDiscovery: process.env.ENABLE_AUTO_DISCOVERY === 'true',
    enableCaching: process.env.ENABLE_CACHING === 'true',
    enableAnalytics: process.env.NODE_ENV === 'production',
  },
  batch: {
    defaultSize: parseInt(process.env.BATCH_SIZE || '30'),
    maxSize: 100,
  },
  ai: {
    model: process.env.AI_MODEL || 'gpt-4o-mini',
    temperature: parseFloat(process.env.AI_TEMPERATURE || '0.7'),
  },
};
```

Use in code:

```typescript
import { config } from '@/lib/config';

if (config.features.enableCaching) {
  // Use cache
}
```

## Logging Configuration

### Convex Logging

```typescript
// In Convex functions
console.log('Info message');
console.error('Error message');
console.warn('Warning message');

// Structured logging
console.log({
  level: 'info',
  message: 'Casino discovered',
  casino: casinoName,
  state: stateAbbr,
});
```

### Log Levels

View specific log levels:

```bash
# All logs
npx convex logs --prod

# Errors only
npx convex logs --prod --level error

# Warnings and errors
npx convex logs --prod --level warn
```

## Monitoring Configuration

### Enable Detailed Metrics

In Convex functions:

```typescript
const startTime = Date.now();

// Your operation

const duration = Date.now() - startTime;
console.log({
  operation: 'casino_discovery',
  duration,
  status: 'success',
  metrics: {
    discovered: 10,
    saved: 8,
    skipped: 2,
  },
});
```

## Backup and Recovery

### Database Backups

Convex automatically handles backups. To export data:

```typescript
// Export all casinos
const allCasinos = await ctx.db.query('casinos').collect();
// Save to file or external storage
```

### Restore Strategy

1. Deploy clean Convex instance
2. Run migration scripts to populate data
3. Update environment variables
4. Test thoroughly

## Summary

Key configuration files:

- `.env.local` - Environment variables
- `convex/crons.ts` - Scheduled jobs
- `next.config.ts` - Next.js settings
- `tailwind.config.ts` - UI theming
- Table models - Database indexes
- AI agents - Model settings
- Service files - Business logic parameters
